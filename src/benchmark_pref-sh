#!/bin/bash

# Script de teste para benchmark de threads com perf stat
# Testa de 1 a 20 threads

# Nome do executável
EXECUTABLE="../zpic"
INPUT_DIR="../input"
MAKE_COMMAND="make"

# Ficheiro de output
OUTPUT_FILE="thread_benchmark_results.txt"
CSV_FILE="thread_benchmark.csv"
PERF_FILE="perf_stats.txt"
ENERGY_FILE="energy_results.txt"

# Array para armazenar resultados
declare -a results
declare -a times
declare -a energies

# Verificar se o directório input existe
if [ ! -d "$INPUT_DIR" ]; then
    echo "Erro: Directório $INPUT_DIR não encontrado!"
    exit 1
fi

# Verificar se perf está disponível
if ! command -v perf &> /dev/null; then
    echo "Erro: 'perf' não está instalado!"
    echo "Instale com: sudo apt-get install linux-tools-common linux-tools-generic"
    exit 1
fi

# Compilar o código primeiro
echo "A compilar o código..."
make clean
make

if [ ! -f "$EXECUTABLE" ]; then
    echo "Erro: Executável $EXECUTABLE não foi criado!"
    exit 1
fi

echo "Iniciando benchmark de threads com perf stat -r 5..."
echo "======================================================"

# Ficheiros para estatísticas
echo "Estatísticas detalhadas do perf stat" > $PERF_FILE
echo "=====================================" >> $PERF_FILE

echo "Resultados de Energia por Thread" > $ENERGY_FILE
echo "================================" >> $ENERGY_FILE
echo "Threads | Energia Final" >> $ENERGY_FILE
echo "--------|--------------" >> $ENERGY_FILE

# Executar para diferentes números de threads
for threads in {1..20}; do
    echo "A testar com $threads thread(s)..."
    
    # Definir número de threads
    export OMP_NUM_THREADS=$threads
    
    # Executar com perf stat -r 5 (5 execuções)
    echo "" >> $PERF_FILE
    echo "Threads: $threads" >> $PERF_FILE
    echo "----------------" >> $PERF_FILE
    
    # Executar perf stat e capturar output COMPLETO do programa
    perf_output=$(perf stat -r 5 -o perf_tmp.txt $EXECUTABLE 2>&1)
    
    # Guardar output detalhado do perf
    cat perf_tmp.txt >> $PERF_FILE
    
    # Extrair o tempo médio do output do perf
    time_elapsed=$(grep "seconds time elapsed" perf_tmp.txt | head -1)
    time_value=$(echo "$time_elapsed" | awk '{print $1}')
    
    # EXTRAIR ENERGIA FINAL - Correção aqui
    # Procura específica por "Final energy:" que aparece no FINAL da execução
    energy_line=$(echo "$perf_output" | grep "Final energy:" | tail -1)
    
    if [ -n "$energy_line" ]; then
        # Extrai o valor numérico (terceira coluna)
        energy_value=$(echo "$energy_line" | awk '{print $3}')
        echo "  DEBUG: Linha de energia encontrada: $energy_line" >&2
        echo "  DEBUG: Valor extraído: $energy_value" >&2
    else
        # Tentativa alternativa de busca
        energy_line=$(echo "$perf_output" | grep -A2 -B2 "energy")
        echo "  DEBUG: Não encontrou 'Final energy:', output relevante:" >&2
        echo "$energy_line" >&2
        energy_value="N/A"
    fi
    
    # Guardar energia no ficheiro
    if [ "$energy_value" != "N/A" ] && [ -n "$energy_value" ]; then
        printf "%7d | %s\n" $threads "$energy_value" >> $ENERGY_FILE
        energies[$threads]=$energy_value
    else
        printf "%7d | %s\n" $threads "N/A" >> $ENERGY_FILE
        energies[$threads]="N/A"
    fi
    
    # Limpar ficheiro temporário
    rm -f perf_tmp.txt
    
    # Verificar se conseguiu extrair o tempo
    if [ -z "$time_value" ] || [ "$time_value" = "?" ]; then
        echo "  AVISO: Não foi possível extrair o tempo para $threads threads"
        time_value="0"
    fi
    
    # Guardar resultados
    results[$threads]="$threads $time_value"
    times[$threads]=$time_value
    
    # Mostrar resultado com tempo e energia FINAL
    if [ "$energy_value" != "N/A" ] && [ -n "$energy_value" ]; then
        echo "  Threads: $threads, Tempo médio: ${time_value}s (5 execuções), Energia FINAL: ${energy_value}"
    else
        echo "  Threads: $threads, Tempo médio: ${time_value}s (5 execuções), Energia FINAL: N/A"
    fi
done

# Calcular speedup (relativo a 1 thread)
base_time=${times[1]}
echo ""
echo "Resultados do Benchmark:"
echo "======================================"

# Escrever para ficheiro de texto
echo "Resultados do Benchmark de Threads (perf stat -r 5)" > $OUTPUT_FILE
echo "====================================================" >> $OUTPUT_FILE
echo "Threads | Tempo (s) | Speedup | Eficiência (%) | Energia Final" >> $OUTPUT_FILE
echo "--------|-----------|---------|---------------|--------------" >> $OUTPUT_FILE

# Escrever para CSV
echo "Threads,Tempo(s),Speedup,Eficiencia(%),EnergiaFinal" > $CSV_FILE

for threads in {1..20}; do
    time=${times[$threads]}
    energy=${energies[$threads]}
    
    # Converter para float para cálculos (usando bc)
    if [ $(echo "$time > 0" | bc 2>/dev/null || echo "0") -eq 1 ] && [ $(echo "$base_time > 0" | bc 2>/dev/null || echo "0") -eq 1 ]; then
        speedup=$(echo "scale=2; $base_time / $time" | bc 2>/dev/null || echo "N/A")
        efficiency=$(echo "scale=2; ($speedup / $threads) * 100" | bc 2>/dev/null || echo "N/A")
    else
        speedup="N/A"
        efficiency="N/A"
    fi
    
    # Formatar output para tabela
    if [ "$time" != "N/A" ] && [ "$time" != "0" ]; then
        if [ "$energy" != "N/A" ] && [ -n "$energy" ]; then
            printf "%7d | %9.3f | %7s | %13s | %s\n" $threads $time $speedup $efficiency "$energy" >> $OUTPUT_FILE
            echo "$threads,$time,$speedup,$efficiency,$energy" >> $CSV_FILE
            
            # Mostrar no terminal também
            printf "%7d | %9.3f | %7s | %13s | %s\n" $threads $time $speedup $efficiency "$energy"
        else
            printf "%7d | %9.3f | %7s | %13s | %s\n" $threads $time $speedup $efficiency "N/A" >> $OUTPUT_FILE
            echo "$threads,$time,$speedup,$efficiency,N/A" >> $CSV_FILE
            printf "%7d | %9.3f | %7s | %13s | %s\n" $threads $time $speedup $efficiency "N/A"
        fi
    else
        printf "%7d | %9s | %7s | %13s | %s\n" $threads "N/A" "N/A" "N/A" "$energy" >> $OUTPUT_FILE
        echo "$threads,N/A,N/A,N/A,$energy" >> $CSV_FILE
        printf "%7d | %9s | %7s | %13s | %s\n" $threads "N/A" "N/A" "N/A" "$energy"
    fi
done

echo ""
echo "Resultados guardados em:"
echo "  - $OUTPUT_FILE (tabela completa)"
echo "  - $CSV_FILE (formato CSV)"
echo "  - $PERF_FILE (estatísticas perf)"
echo "  - $ENERGY_FILE (apenas energias)"

# Gerar gráficos (se gnuplot estiver disponível)
if command -v gnuplot &> /dev/null && [ -f "$CSV_FILE" ]; then
    echo "A gerar gráficos..."
    
    # Criar versão do CSV sem valores N/A para o gnuplot
    grep -v "N/A" $CSV_FILE > plot_data.csv
    
    if [ -s plot_data.csv ]; then
        # Gráfico 1: Tempo e Speedup
        gnuplot << EOF
        set terminal pngcairo size 1000,600 enhanced font 'Verdana,10'
        set output 'thread_benchmark_plot.png'
        set title 'Benchmark de Threads - perf stat -r 5'
        set xlabel 'Número de Threads'
        set ylabel 'Tempo (s)'
        set y2label 'Speedup'
        set y2tics
        set grid
        set key outside right top
        
        plot 'plot_data.csv' using 1:2 with linespoints title 'Tempo (s)' axes x1y1, \
             'plot_data.csv' using 1:3 with linespoints title 'Speedup' axes x1y2
EOF

        # Gráfico 2: Energia FINAL vs Threads
        gnuplot << EOF
        set terminal pngcairo size 800,600 enhanced font 'Verdana,10'
        set output 'energy_vs_threads.png'
        set title 'Energia FINAL vs Número de Threads'
        set xlabel 'Número de Threads'
        set ylabel 'Energia Final'
        set grid
        
        plot 'plot_data.csv' using 1:5 with linespoints title 'Energia Final'
EOF
        
        rm -f plot_data.csv
        echo "  - thread_benchmark_plot.png (tempo e speedup)"
        echo "  - energy_vs_threads.png (energia FINAL vs threads)"
    else
        echo "  - Não foi possível gerar gráficos (dados insuficientes)"
        rm -f plot_data.csv
    fi
fi

echo ""
echo "Benchmark completo!"
echo "Nota: Os tempos são médias de 5 execuções por configuração de threads"